<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySql Xtrabackup备份与恢复 | Xiewh’s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?3d52586f71b748615341de04290311c6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script>
    <meta name="description" content="欢迎访问 Xiewh’s Blog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="xiewh,博客,blog,php,go,golang">
    <meta name="baidu-site-verification" content="code-ts2gr50PnF">
    
    <link rel="preload" href="/assets/css/0.styles.cf42c520.css" as="style"><link rel="preload" href="/assets/js/app.8273ef65.js" as="script"><link rel="preload" href="/assets/js/3.61216f1d.js" as="script"><link rel="preload" href="/assets/js/1.d8658f05.js" as="script"><link rel="preload" href="/assets/js/15.7fbf2828.js" as="script"><link rel="prefetch" href="/assets/js/10.64f76524.js"><link rel="prefetch" href="/assets/js/11.07e19ea2.js"><link rel="prefetch" href="/assets/js/12.e568bebb.js"><link rel="prefetch" href="/assets/js/13.b7ef2cac.js"><link rel="prefetch" href="/assets/js/14.ec752f39.js"><link rel="prefetch" href="/assets/js/16.3e375c56.js"><link rel="prefetch" href="/assets/js/17.049eef7e.js"><link rel="prefetch" href="/assets/js/18.006c732d.js"><link rel="prefetch" href="/assets/js/4.3f3acb27.js"><link rel="prefetch" href="/assets/js/5.c5b8db47.js"><link rel="prefetch" href="/assets/js/6.c233d89d.js"><link rel="prefetch" href="/assets/js/7.20aa3d34.js"><link rel="prefetch" href="/assets/js/8.77ad23b4.js"><link rel="prefetch" href="/assets/js/9.b662087a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cf42c520.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Xiewh’s Blog</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>欢迎访问 Xiewh’s Blog</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>xiewh</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Xiewh’s Blog" class="logo"> <span class="site-name">Xiewh’s Blog</span></a> <div class="links"><!----> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/Git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySql/" class="nav-link"><i class="undefined"></i>
  MySql
</a></li><li class="dropdown-item"><!----> <a href="/categories/Xtrabackup/" class="nav-link"><i class="undefined"></i>
  Xtrabackup
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/PHP/" class="nav-link"><i class="undefined"></i>
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/categories/PHP-FPM/" class="nav-link"><i class="undefined"></i>
  PHP-FPM
</a></li><li class="dropdown-item"><!----> <a href="/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/logo.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    xiewh
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>7</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>8</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6><li class="social-item" data-v-828910c6><i class="iconfont reco-github" style="color:#fb9b5f;" data-v-828910c6></i></li></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/http/" class="nav-link"><i class="undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/categories/Git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/categories/MySql/" class="nav-link"><i class="undefined"></i>
  MySql
</a></li><li class="dropdown-item"><!----> <a href="/categories/Xtrabackup/" class="nav-link"><i class="undefined"></i>
  Xtrabackup
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/PHP/" class="nav-link"><i class="undefined"></i>
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/categories/PHP-FPM/" class="nav-link"><i class="undefined"></i>
  PHP-FPM
</a></li><li class="dropdown-item"><!----> <a href="/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>MySql Xtrabackup备份与恢复</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>xiewh</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">MySql Xtrabackup备份与恢复</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>xiewh</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2021/6/23</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/mysql/xtrabackup.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>MySql</span><span class="tag-item" data-v-1ff7123e>Xtrabackup</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title"></p><p>MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工具，xtrabakackup有2个工具，分别是xtrabakup、innobakupe。</p></div> <h2 id="xtrabackup介绍"><a href="#xtrabackup介绍" class="header-anchor">#</a> Xtrabackup介绍</h2> <p>      MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工具，xtrabakackup有2个工具，分别是xtrabakup、innobakupe。</p> <p>      Percona-xtrabackup是Percona公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。</p> <h2 id="xtrabackup优点"><a href="#xtrabackup优点" class="header-anchor">#</a> Xtrabackup优点</h2> <ul><li>备份速度快，物理备份可靠</li> <li>备份过程不会打断正在执行的事务（无需锁表）</li> <li>能够基于压缩等功能节约磁盘空间和流量</li> <li>自动备份校验</li> <li>还原速度快</li> <li>可以流传将备份传输到另外一台机器上</li> <li>在不增加服务器负载的情况备份数据</li></ul> <h2 id="xtrabackup备份原理"><a href="#xtrabackup备份原理" class="header-anchor">#</a> Xtrabackup备份原理</h2> <ul><li>innobackupex启动后，会先fork一个进程，用于启动xtrabackup，然后等待xtrabackup备份ibd数据文件；</li> <li>xtrabackup在备份innoDB数据是，有2种线程：redo拷贝线程和ibd数据拷贝线程。xtrabackup进程开始执行后，会启动一个redo拷贝的线程，用于从最新的checkpoint点开始顺序拷贝redo.log；再启动ibd数据拷贝线程，进行拷贝ibd数据。这里是先启动redo拷贝线程的。在此阶段，innobackupex进行处于等待状态（等待文件被创建）</li> <li>xtrabackup拷贝完成ibd数据文件后，会通知innobackupex（通过创建文件），同时xtrabackup进入等待状态（redo线程依旧在拷贝redo.log）</li> <li>innobackupex收到xtrabackup通知后哦，执行FLUSH TABLES WITH READ LOCK（FTWRL），取得一致性位点，然后开始备份非InnoDB文件（如frm、MYD、MYI、CSV、opt、par等格式的文件），在拷贝非InnoDB文件的过程当中，数据库处于全局只读状态。</li> <li>当innobackup拷贝完所有的非InnoDB文件后，会通知xtrabackup，通知完成后，进入等待状态；</li> <li>xtrabackup收到innobackupex备份完成的通知后，会停止redo拷贝线程，然后通知innobackupex，redo.log文件拷贝完成；</li> <li>innobackupex收到redo.log备份完成后，就进行解锁操作，执行：UNLOCK TABLES；</li> <li>最后innbackupex和xtrabackup进程各自释放资源，写备份元数据信息等，innobackupex等xtrabackup子进程结束后退出。</li></ul> <h2 id="xtrabackup的安装部署以及备份恢复实现"><a href="#xtrabackup的安装部署以及备份恢复实现" class="header-anchor">#</a> xtrabackup的安装部署以及备份恢复实现</h2> <h4 id="xtrabackup的安装"><a href="#xtrabackup的安装" class="header-anchor">#</a> xtrabackup的安装</h4> <blockquote><p>下载地址： https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST</p></blockquote> <p>可以选择rpm包方式安装，也可以下载源码包编译安装，这里直接采用rpm包的方式进行安装</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>wget https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.21/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.21-1.el7.x86_64.rpm
yum install -y percona-xtrabackup-24-2.4.21-1.el7.x86_64.rpm
rpm -qa |grep xtrabackup

Xtrabackup中主要包含两个工具：
xtrabackup：是用于热备innodb，xtradb表中数据的工具，不能备份其他类型的表，也不能备份数据表结构；
innobackupex：是将xtrabackup进行封装的perl脚本，提供了备份myisam表的能力。
常用选项:  
   --host     指定主机
   --user     指定用户名
   --password    指定密码
   --port     指定端口
   --databases     指定数据库
   --incremental    创建增量备份
   --incremental-basedir   指定包含完全备份的目录
   --incremental-dir      指定包含增量备份的目录   
   --apply-log        对备份进行预处理操作             
     一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使得数据文件处于一致性状态。
   --redo-only      不回滚未提交事务
   --copy-back     恢复备份目录
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>使用innobackupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有关于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相关文件，同时还会备份触发器和数据库配置信息相关的文件，这些文件会被保存到一个以时间命名的目录当中。在备份的同时，innobackupex还会在备份目录中创建如下文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>(1)xtrabackup_checkpoints -- 备份类型(如完全或增量)、备份状态(如是否已经为prepared状态)和LSN(日志序列号)范围信息：

每个InnoDB页(通常为16k大小)
都会包含一个日志序列号，即LSN，LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的。

(2)xtrabackup_binlog_info  --  mysql服务器当前正在使用的二进制日志文件及备份这一刻位置二进制日志时间的位置。

(3)xtrabackup_binlog_pos_innodb  --  二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当前position。

(4)xtrabackup_binary  --  备份中用到的xtrabackup的可执行文件；

(5)backup-my.cnf  --  备份命令用到的配置选项信息：

在使用innobackupex进行备份时，还可以使用--no-timestamp选项来阻止命令自动创建一个以时间命名的目录：如此一来，innobackupex命令将会创建一个BACKUP-DIR目录来存储备份数据。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; CREATE USER 'bkpuser'@'localhost' IDENTIFIED BY '123456';　　#创建用户
mysql&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM 'bkpuser';　　#回收此用户所有权限
mysql&gt; GRANT RELOAD,LOCK TABLES,RELICATION CLIENT ON *.* TO 'bkpuser'@'localhost';　　#授权刷新、锁定表、用户查看服务器状态
mysql&gt; FLUSH PRIVILEGES;　　#刷新授权表
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>注意：备份时需启动MySQL,恢复时需关闭MySQL,清空mysql数据目录且不能重新初始化,恢复数据后应该立即进行一次完全备份</p></blockquote> <h4 id="xtrabackup全量备份与恢复"><a href="#xtrabackup全量备份与恢复" class="header-anchor">#</a> xtrabackup全量备份与恢复</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 备份：
innobackupex --user=DBUSER --password=DBUSERPASS --defaults-file=/etc/my.cnf /path/to/BACKUP-DIR/

// 恢复：
innobackupex --apply-log /backups/2018-07-30_11-04-55/
innobackupex --copy-back --defaults-file=/etc/my.cnf  /backups/2018-07-30_11-04-55/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>准备(prepare)一个完全备份</li></ul> <p>一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或者已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处于不一致状态。&quot;准备&quot;的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使用得数据文件处于一致性状态。</p> <p>innobackupex命令的--apply-log选项可用于实现上述功能，如下面的命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>innobackupex --apply-log /path/to/BACKUP-DIR
如果执行正确，其最后输出的几行信息通常如下：

120407 09:01:04 innobackupex: completed OK!

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在实现&quot;准备&quot;的过程中，innobackupex通常还可以使用--user-memory选项来指定其可以使用的内存的大小，默认为100M.如果有足够的内存空间可用，可以多划分一些内存给prepare的过程，以提高其完成备份的速度。</p> <ul><li>从一个完全备份中恢复数据</li></ul> <blockquote><p>注意：恢复不用启动MySQL</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>// innobackupex命令的--copy-back选项用于恢复操作，其通过复制所有数据相关的文件至mysql服务器DATADIR目录中来执行恢复过程。innobackupex通过backup-my.cnf来获取DATADIR目录的相关信息。
innobackupex --copy-back /path/to/BACKUP-DIR

// 当数据恢复至DATADIR目录以后，还需要确保所有的数据文件的属主和属组均为正确的用户，如mysql，否则，在启动mysqld之前还需要事先修改数据文件的属主和属组。如：
<span class="token function">chown</span> -R mysql.mysql /mydata/data/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>实战练习</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>（1）全量备份
<span class="token punctuation">[</span>root@master backups<span class="token punctuation">]</span><span class="token comment"># innobackupex --user=root --password=123456 --host=127.0.0.1 /backups/　　#在master上进行全库备份#语法解释说明：</span>
<span class="token comment">#--user=root 指定备份用户</span>
<span class="token comment">#--password=123456  指定备份用户密码</span>
<span class="token comment">#--host　　指定主机</span>
<span class="token comment">#/backups　　指定备份目录</span>
<span class="token punctuation">[</span>root@master backups<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">0</span>
drwxr-x--- <span class="token number">7</span> root root <span class="token number">232</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 <span class="token number">2018</span>-07-30_11-01-37
<span class="token punctuation">[</span>root@master backups<span class="token punctuation">]</span><span class="token comment"># ll 2018-07-30_11-01-37/　　#查看备份数据</span>
total <span class="token number">77856</span>
-rw-r----- <span class="token number">1</span> root root      <span class="token number">418</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 backup-my.cnf　　<span class="token comment">#备份用到的配置选项信息文件</span>
-rw-r----- <span class="token number">1</span> root root <span class="token number">79691776</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 ibdata1　　<span class="token comment">#数据文件</span>
drwxr-x--- <span class="token number">2</span> root root       <span class="token number">20</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 kim
drwxr-x--- <span class="token number">2</span> root root     <span class="token number">4096</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 mysql
drwxr-x--- <span class="token number">2</span> root root     <span class="token number">4096</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 performance_schema
drwxr-x--- <span class="token number">2</span> root root       <span class="token number">20</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 repppp
drwxr-x--- <span class="token number">2</span> root root     <span class="token number">4096</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 wordpress
-rw-r----- <span class="token number">1</span> root root       <span class="token number">21</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 xtrabackup_binlog_info　　<span class="token comment">#mysql服务器当前正在使用的二进制日志文件和此时二进制日志时间的位置信息文件</span>
-rw-r----- <span class="token number">1</span> root root      <span class="token number">113</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 xtrabackup_checkpoints　　<span class="token comment">#备份的类型、状态和LSN状态信息文件</span>
-rw-r----- <span class="token number">1</span> root root      <span class="token number">482</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 xtrabackup_info
-rw-r----- <span class="token number">1</span> root root     <span class="token number">2560</span> Jul <span class="token number">30</span> <span class="token number">11</span>:01 xtrabackup_logfile　　　　<span class="token comment">#备份的日志文件</span>

（2）恢复
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysqld stop　　#停止slave上的mysql</span>
Shutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token operator">!</span> 

<span class="token punctuation">[</span>root@slave tools<span class="token punctuation">]</span><span class="token comment"># yum install -y percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm 　　#安装xtrabackup</span>
<span class="token punctuation">[</span>root@master backups<span class="token punctuation">]</span><span class="token comment"># scp -r 2018-07-30_11-01-37/ root@192.168.56.12:/backups/　　 #从master上拷贝备份数据</span>
<span class="token punctuation">[</span>root@slave tools<span class="token punctuation">]</span><span class="token comment"># innobackupex --apply-log /backups/2018-07-30_11-01-37/　　　　　 #合并数据，使数据文件处于一致性的状态</span>
<span class="token number">180729</span> <span class="token number">23</span>:18:23 innobackupex: Starting the apply-log operation

IMPORTANT: Please check that the apply-log run completes successfully.
           At the end of a successful apply-log run innobackupex
           prints <span class="token string">&quot;completed OK!&quot;</span><span class="token builtin class-name">.</span>

innobackupex version <span class="token number">2.4</span>.9 based on MySQL server <span class="token number">5.7</span>.13 Linux <span class="token punctuation">(</span>x86_64<span class="token punctuation">)</span> <span class="token punctuation">(</span>revision id: a467167cdd4<span class="token punctuation">)</span>
xtrabackup: <span class="token builtin class-name">cd</span> to /backups/2018-07-30_11-01-37/
xtrabackup: This target seems to be not prepared yet.
InnoDB: Number of pools: <span class="token number">1</span>
xtrabackup: xtrabackup_logfile detected: <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">8388608</span>, <span class="token assign-left variable">start_lsn</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3127097</span><span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
InnoDB: FTS optimize thread exiting.
InnoDB: Starting shutdown<span class="token punctuation">..</span>.
InnoDB: Shutdown completed<span class="token punctuation">;</span> log sequence number <span class="token number">3129915</span>
<span class="token number">180729</span> <span class="token number">23</span>:18:30 completed OK<span class="token operator">!</span>
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /usr/local/mysql/data/　　#在slave上删除原有的数据</span>
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/my.cnf　　#配置my.cnf的数据目录路径，否则会报错，要和master一致</span>
<span class="token assign-left variable">datadir</span><span class="token operator">=</span>/usr/local/mysql/data
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># innobackupex --copy-back /backups/2018-07-30_11-01-37/　　#在slave上数据恢复</span>
<span class="token number">180729</span> <span class="token number">23</span>:32:03 innobackupex: Starting the copy-back operation

IMPORTANT: Please check that the copy-back run completes successfully.
           At the end of a successful copy-back run innobackupex
           prints <span class="token string">&quot;completed OK!&quot;</span><span class="token builtin class-name">.</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">180729</span> <span class="token number">23</span>:32:08 completed OK<span class="token operator">!</span>　　<span class="token comment">#看到completed OK就是恢复正常了</span>
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># ll /usr/local/mysql/data/　　#slave上查看数据目录，可以看到数据已经恢复，但是属主会有问题，需要进行修改，所以一般使用mysql的运行用户进行恢复，否则需要进行修改属主和属组信息</span>
total <span class="token number">188432</span>
-rw-r----- <span class="token number">1</span> root root <span class="token number">79691776</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 ibdata1
-rw-r----- <span class="token number">1</span> root root <span class="token number">50331648</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 ib_logfile0
-rw-r----- <span class="token number">1</span> root root <span class="token number">50331648</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 ib_logfile1
-rw-r----- <span class="token number">1</span> root root <span class="token number">12582912</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 ibtmp1
drwxr-x--- <span class="token number">2</span> root root       <span class="token number">20</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 kim
drwxr-x--- <span class="token number">2</span> root root     <span class="token number">4096</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 mysql
drwxr-x--- <span class="token number">2</span> root root     <span class="token number">4096</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 performance_schema
drwxr-x--- <span class="token number">2</span> root root       <span class="token number">20</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 repppp
drwxr-x--- <span class="token number">2</span> root root     <span class="token number">4096</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 wordpress
-rw-r----- <span class="token number">1</span> root root      <span class="token number">482</span> Jul <span class="token number">29</span> <span class="token number">23</span>:32 xtrabackup_info
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># chown -R mysql.mysql /usr/local/mysql/data/　　#修改属主属组</span>
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># /etc/init.d/mysqld start　　#启动mysql</span>
Starting MySQL. SUCCESS<span class="token operator">!</span> 
<span class="token punctuation">[</span>root@slave ~<span class="token punctuation">]</span><span class="token comment"># mysql -uroot -p -e &quot;show databases;&quot;　　#查看数据，是否恢复</span>
Enter password: 
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
<span class="token operator">|</span> kim                <span class="token operator">|</span>
<span class="token operator">|</span> mysql              <span class="token operator">|</span>
<span class="token operator">|</span> performance_schema <span class="token operator">|</span>
<span class="token operator">|</span> repppp             <span class="token operator">|</span>
<span class="token operator">|</span> wordpress          <span class="token operator">|</span>
+--------------------+

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><div class="language- extra-class"><pre><code>总结全库备份与恢复三步曲：
a.　innobackupex全量备份，并指定备份目录路径；
b.　在恢复前，需要使用--apply-log参数先进行合并数据文件，确保数据的一致性要求；
c.　恢复时，直接使用--copy-back参数进行恢复，需要注意的是，在my.cnf中要指定数据文件目录的路径。
</code></pre></div><h4 id="xtrabackup增量备份与恢复"><a href="#xtrabackup增量备份与恢复" class="header-anchor">#</a> xtrabackup增量备份与恢复</h4> <p>      使用innobackupex进行增量备份，每个InnoDB的页面都会包含一个LSN信息，每当相关的数据发生改变，相关的页面的LSN就会自动增长。这正是InnoDB表可以进行增量备份的基础，即innobackupex通过备份上次完全备份之后发生改变的页面来实现。在进行增量备份时，首先要进行一次全量备份，第一次增量备份是基于全备的，之后的增量备份都是基于上一次的增量备份的，以此类推。</p> <p>要实现第一次增量备份，可以使用下面的命令进行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>基于全量备份的增量备份与恢复
做一次增量备份（基于当前最新的全量备份）
innobackupex --user=root --password=root --defaults-file=/etc/my.cnf --incremental /backups/ --incremental-basedir=/backups/2018-07-30_11-01-37
1. 准备基于全量
innobackupex --user=root --password=root --defaults-file=/etc/my.cnf --apply-log --redo-only /backups/2018-07-30_11-01-37
2. 准备基于增量
innobackupex --user=root --password=root --defaults-file=/etc/my.cnf --apply-log --redo-only /backups/2018-07-30_11-01-37 --incremental-dir=/backups/2018-07-30_13-51-47/
3. 恢复
innobackupex --copy-back --defaults-file=/etc/my.cnf /opt/2017-01-05_11-04-55/
解释：
1. 2018-07-30_11-01-37指的是完全备份所在的目录。
2. 2018-07-30_13-51-47指定是第一次基于2018-07-30_11-01-37增量备份的目录，其他类似以此类推，即如果有多次增量备份。每一次都要执行如上操作。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。</p> <ul><li><p>&quot;准备&quot;(prepare)增量备份与整理完全备份有着一些不同，尤其要注意的是：</p> <ul><li>需要在每个备份 (包括完全和各个增量备份)上，将已经提交的事务进行&quot;重放&quot;。&quot;重放&quot;之后，所有的备份数据将合并到完全备份上。</li> <li>基于所有的备份将未提交的事务进行&quot;回滚&quot;</li></ul></li> <li><p>增量备份演示</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@master backups]# innobackupex --user=root --password=123456 --host=127.0.0.1 /backups/   #全备数据
[root@master ~]# mysql -uroot -p　　#在master上创建student库并创建testtb表插入若干数据
Enter password: 
mysql&gt; create database student;
Query OK, 1 row affected (0.03 sec)

mysql&gt; use student;
Database changed
mysql&gt; create table testtb(id int);
Query OK, 0 rows affected (0.07 sec)

mysql&gt; insert into testtb values(1),(10),(99);
Query OK, 3 rows affected (0.04 sec)
Records: 3  Duplicates: 0  Warnings: 0

mysql&gt; select * from testtb;
+------+
| id   |
+------+
|    1 |
|   10 |
|   99 |
+------+
3 rows in set (0.00 sec)

mysql&gt; quit;
Bye

#使用innobackupex进行增量备份
[root@master backups]# innobackupex --user=root --password=123456 --host=127.0.0.1 --incremental /backups/ --incremental-basedir=/backups/2018-07-30_11-01-37/
......
180730 13:51:50 Executing UNLOCK TABLES
180730 13:51:50 All tables unlocked
180730 13:51:50 Backup created in directory '/backups/2018-07-30_13-51-47/'
MySQL binlog position: filename 'mysql-bin.000005', position '664'
180730 13:51:50 [00] Writing /backups/2018-07-30_13-51-47/backup-my.cnf
180730 13:51:50 [00]        ...done
180730 13:51:50 [00] Writing /backups/2018-07-30_13-51-47/xtrabackup_info
180730 13:51:50 [00]        ...done
xtrabackup: Transaction log of lsn (3158741) to (3158741) was copied.
180730 13:51:50 completed OK!
[root@master backups]# ll　　#查看备份数据
total 0
drwxr-x--- 7 root root 232 Jul 30 11:01 2018-07-30_11-01-37　　#全量备份数据目录
drwxr-x--- 8 root root 273 Jul 30 13:51 2018-07-30_13-51-47　　#增量备份数据目录
[root@master 2018-07-30_11-01-37]# cat xtrabackup_checkpoints #查看全量备份的xtrabackup_checkpoints
backup_type = full-backuped　　#备份类型为全量备份
from_lsn = 0　　#lsn从0开始
to_lsn = 3127097　　#lsn到3127097结束
last_lsn = 3127097
compact = 0
recover_binlog_info = 0

[root@master 2018-07-30_13-51-47]# cat xtrabackup_checkpoints 　　#查看增量备份的xtrabackup_checkpoints
backup_type = incremental　　#备份类型为增量备份
from_lsn = 3127097　　#lsn从3127097开始
to_lsn = 3158741　　  #lsn到啊3158741结束
last_lsn = 3158741　　
compact = 0
recover_binlog_info = 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><ul><li>增量备份后数据恢复演示</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）模拟mysql故障，删除数据目录所有数据
[root@master ~]# /etc/init.d/mysqld stop　　#模拟mysql故障，停止mysql
Shutting down MySQL.. SUCCESS! 
[root@master ~]# rm -rf /usr/local/mysql/data/*　　#删除数据目录中的所有数据

（2）合并全备数据目录，确保数据的一致性
[root@master ~]# innobackupex --apply-log --redo-only /backups/2018-07-30_11-01-37/
180730 14:05:27 innobackupex: Starting the apply-log operation

IMPORTANT: Please check that the apply-log run completes successfully.
           At the end of a successful apply-log run innobackupex
           prints &quot;completed OK!&quot;.

innobackupex version 2.4.9 based on MySQL server 5.7.13 Linux (x86_64) (revision id: a467167cdd4)
xtrabackup: cd to /backups/2018-07-30_11-01-37/
......
......
xtrabackup: starting shutdown with innodb_fast_shutdown = 1
InnoDB: Starting shutdown...
InnoDB: Shutdown completed; log sequence number 3127106
InnoDB: Number of pools: 1
180730 14:05:29 completed OK!

（3）将增量备份数据合并到全备数据目录当中
[root@master ~]# innobackupex --apply-log --redo-only /backups/2018-07-30_11-01-37/ --incremental-dir=/backups/2018-07-30_13-51-47/
180730 14:06:42 innobackupex: Starting the apply-log operation

IMPORTANT: Please check that the apply-log run completes successfully.
           At the end of a successful apply-log run innobackupex
           prints &quot;completed OK!&quot;.
......
......
180730 14:06:44 [00]        ...done
180730 14:06:44 completed OK!
[root@master ~]# cat /backups/2018-07-30_11-01-37/xtrabackup_checkpoints 
backup_type = log-applied　　#查看到数据备份类型是增加
from_lsn = 0　　#lsn从0开始
to_lsn = 3158741　　#lsn结束号为最新的lsn
last_lsn = 3158741
compact = 0
recover_binlog_info = 0

（4）恢复数据
[root@master ~]# innobackupex --copy-back /backups/2018-07-30_11-01-37/
180730 14:07:51 innobackupex: Starting the copy-back operation

IMPORTANT: Please check that the copy-back run completes successfully.
           At the end of a successful copy-back run innobackupex
           prints &quot;completed OK!&quot;.
.......
.......
180730 14:08:17 [01]        ...done
180730 14:08:17 completed OK!
[root@master ~]# ll /usr/local/mysql/data/
total 77844
-rw-r----- 1 root root 79691776 Jul 30 14:08 ibdata1
drwxr-x--- 2 root root       20 Jul 30 14:08 kim
drwxr-x--- 2 root root     4096 Jul 30 14:08 mysql
drwxr-x--- 2 root root     4096 Jul 30 14:08 performance_schema
drwxr-x--- 2 root root       20 Jul 30 14:08 repppp
drwxr-x--- 2 root root       56 Jul 30 14:08 student
drwxr-x--- 2 root root     4096 Jul 30 14:08 wordpress
-rw-r----- 1 root root       21 Jul 30 14:08 xtrabackup_binlog_pos_innodb
-rw-r----- 1 root root      554 Jul 30 14:08 xtrabackup_info
[root@master ~]# chown -R mysql.mysql /usr/local/mysql/data　　#更改数据的属主属组
[root@master ~]# /etc/init.d/mysqld start　　#启动mysql
Starting MySQL.Logging to '/usr/local/mysql/data/master.err'.
.. SUCCESS! 
[root@master ~]# mysql -uroot -p -e &quot;show databases;&quot;　　#查看数据是否恢复
Enter password: 
+--------------------+
| Database           |
+--------------------+
| information_schema |
| kim                |
| mysql              |
| performance_schema |
| repppp             |
| student            |
| wordpress          |
+--------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结：</h2> <ul><li>增量备份需要使用参数--incremental指定需要备份到哪个目录，使用incremental-dir指定全备目录；</li> <li>进行数据备份时，需要使用参数--apply-log redo-only先合并全备数据目录数据，确保全备数据目录数据的一致性；</li> <li>再将增量备份数据使用参数--incremental-dir合并到全备数据当中；</li> <li>最后通过最后的全备数据进行恢复数据，注意，如果有多个增量备份，需要逐一合并到全备数据当中，再进行恢复。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>#1.  --user=root 指定备份的用户
#2.  --password=root指定备份用户的密码
#3.  --defaults-file=/etc/my.cnf 指定的备份数据的配置文件
#4.  /opt/ 指定备份后的数据保存路径
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/mysql/xtrabackup.html#xtrabackup介绍" class="sidebar-link reco-side-xtrabackup介绍" data-v-70334359>Xtrabackup介绍</a></li><li class="level-2" data-v-70334359><a href="/mysql/xtrabackup.html#xtrabackup优点" class="sidebar-link reco-side-xtrabackup优点" data-v-70334359>Xtrabackup优点</a></li><li class="level-2" data-v-70334359><a href="/mysql/xtrabackup.html#xtrabackup备份原理" class="sidebar-link reco-side-xtrabackup备份原理" data-v-70334359>Xtrabackup备份原理</a></li><li class="level-2" data-v-70334359><a href="/mysql/xtrabackup.html#xtrabackup的安装部署以及备份恢复实现" class="sidebar-link reco-side-xtrabackup的安装部署以及备份恢复实现" data-v-70334359>xtrabackup的安装部署以及备份恢复实现</a></li><li class="level-2" data-v-70334359><a href="/mysql/xtrabackup.html#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结：</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="left:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 Xiewh’s Blog
    </div> <div class="operation" style="left:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="left:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><div id="goTop" class="hide-cat" data-v-bf92849a></div><div class="Sakura" data-v-017cf06a><canvas id="canvas_sakura" style="z-index:-1;" data-v-017cf06a></canvas></div><!----><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.8273ef65.js" defer></script><script src="/assets/js/3.61216f1d.js" defer></script><script src="/assets/js/1.d8658f05.js" defer></script><script src="/assets/js/15.7fbf2828.js" defer></script>
  </body>
</html>
